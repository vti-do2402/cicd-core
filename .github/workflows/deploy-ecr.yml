name: Deploy to Amazon ECR Workflow
description: Build and Push Docker Image to ECR

on:
  workflow_call:
    inputs:
      runs_on:
        type: string
        default: mock-project
        description: The runner to use for the action
      environment:
        type: string
        required: true
        default: development
        description: The environment to push the image to (development, staging, production)
      github_token:
        type: string
        required: true
        description: The GitHub token to use for the action
      default_bump:
        type: string
        required: false
        default: patch
        description: The default bump type to use for the action (patch, minor, major)
      ecr_repository:
        type: string
        required: true
        description: The repository to push the image to
      docker_build_context:
        type: string
        default: .
        description: The context to build the image in
      dockerfile:
        type: string
        default: Dockerfile
        description: The Dockerfile to use for the image
      image_tag:
        type: string
        required: true
        description: The tag to use for the image
      aws_account_id:
        type: string
        required: true
        description: The AWS account ID to use for the action
      aws_region:
        type: string
        default: us-west-2
        description: The AWS region to use for the action

jobs:
  deploy-ecr:
    name: Deploy to Amazon ECR
    runs-on: ${{ inputs.runs_on }}
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important for Sonar analysis

      - name: Calculate or Create Tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ inputs.github_token }}
          default_bump: ${{ inputs.default_bump }}
          dry_run: false

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}
          draft: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ inputs.aws_account_id }}:role/github-actions
          aws-region: ${{ inputs.aws_region }}

      - name: Login to Amazon ECR
        id: login_ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ inputs.aws_account_id }}

      - name: Build, Tag, and Push Docker Image to ECR
        shell: bash
        env:
          REGISTRY: ${{ steps.login_ecr.outputs.registry }}
          REPOSITORY: ${{ inputs.ecr_repository }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          DOCKERFILE_PATH: ${{ inputs.dockerfile }}
          DOCKER_BUILD_DIRECTORY: ${{ inputs.docker_build_context }}
        run: |
          docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG -f $DOCKERFILE_PATH $DOCKER_BUILD_DIRECTORY
          docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
          echo "Image tag: $IMAGE_TAG"
          echo "Push image to ECR: $REGISTRY/$REPOSITORY:$IMAGE_TAG"
